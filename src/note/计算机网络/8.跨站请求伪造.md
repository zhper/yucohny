# 什么是 CSRF 攻击

**CSRF Cross Site Request Forgery 跨站请求伪造**，是黑客引诱用户打开黑客的网站，并在黑客的网站中，利用用户的登录状态发起的跨站请求。即，CSRF 攻击是黑客利用了用户的登录状态，并通过第三方站点来进行其他操作。

当用户打开了黑客的页面后，黑客有三种方式去实施 CSRF 攻击：

1. 自动发起 GET 请求。
2. 自动发起 POST 请求。

比如转账对应了某个接口，如果黑客可以实现自动发起请求，那么就可以实现自动转账。

3. 引诱用户点击链接。

表面上看起来链接就是链接，但是链接可能是对应了某个接口的 URL，这样点击链接跳转就变为了向该接口发起请求，信息就遭到了泄露。

和 XSS 攻击不同的是，CSRF 攻击不需要将恶意代码注入用户的页面，仅仅是利⽤服务器的漏洞和用户的登录状态来实施攻击。

# 如何防止 CSRF 攻击

了解了 CSRF 攻击的⼀些手段后，我们来看看 CSRF 攻击具备的一些特征，并根据这些特征来分析如何防止 CSRF 攻击。总结发起 CSRF 攻击的三个必要条件如下：

1. 目标站点本身存在 CSRF 漏洞。
2. 用户登录过目标站点，并且在浏览器上保持有该站点的登录状态。
3. 需要用户打开⼀个第三方站点，这个站点可以是黑客的站点，也可以是⼀些论坛。 

满足这三个条件后，黑可以就可以对用户进行 CSRF 攻击了。需要注意的是，与 XSS 攻击不同，CSRF 攻击不会往页面注⼊恶意脚本，因此黑客无法通过 CSRF 攻击获取用户页面数据。

而在这三个条件中最关键的一点是要能找到服务器的漏洞，所以说对于 CSRF 攻击我们主要的防护手段是提升服务器的安全性。 

要让服务器防范 CSRF 攻击，通常有以下几种途径。

## 充分利用 Cookie 的 SameSite 属性

黑客会利用用户的登录状态来发起 CSRF 攻击，而 Cookie 恰是浏览器和服务器之间维护登陆状态的一个关键数据。因此如果想要防范 CSRF 攻击，首先就需要考虑在 Cookie 上做文章。

通常 CSRF 攻击都是从第三方站点发起的，要防止 CSRF 攻击，那么最好能够实现从第三方站点发送请求时禁止 Cookie 的发送。

即：

+ 如果 HTTP 请求是同一站点发起的请求，那么就需要保证 Cookie 数据正常发送。
+ 如果是从第三方站点发起请求，那么需要浏览器禁止发送某些关键 Cookie 数据到服务器。

而使用 Cookie 中的 `SameSite` 属性则可以解决这个问题，有效降低 CSRF 攻击的风险。

在 HTTP 响应头中，通过 `set-cookie` 字段设置 Cookie 时，可以添加上 `SameSite` 属性。

`SameSite` 属性通常有 `Strict`、`Lax` 和 `None` 三个选项：

+ `Strict` 最为严格，浏览器会完全禁止第三方 Cookie。
+ `Lax` 相对宽松一点：在跨站点的情况下，从第三方站点的链接打开，和从第三方站点提交 Get 方式的表单，这两种方式都会携带 Cookie。但是如果在第三方站点中使⽤ Post 方法，或者通过 `img`、`iframe` 等标签加载的 URL，这些场景都不会携带 Cookie。

+ `None` 对于发送 Cookie 没有任何限制。

## 验证请求的来源站点

想要通过验证请求的来源站点的方式来防范 CSRF 攻击，非常重要的一个地方就在于服务器如何判断请求是否来自第三方站点。

这就需要了解 HTTP 请求头中的 `Referer` 和 `Origin` 属性。

`Referer` 是 HTTP 请求头中的一个字段，记录了该 HTTP 请求的来源地址。虽然可以通过 `Referer` 字段告诉服务器 HTTP 请求的来源，但是有一些场景并不适合将来源 URL 暴露给服务器。因此实际上浏览器给开发者提供了一个选项，可以不用上传 `Referer` 字段。

因此，在服务端验证请求头中的 `Referer` 字段并不是太可靠，因此标准委员会又制定了 `Origin` 属性。`Origin` 属性与 `Referer` 属性的一个主要区别就在于，`Origin` 属性只包含了域名信息，并不包含具体的 URL 路径。

因此，服务器的策略是优先判断 `Origin` 属性，如果请求头中没有包含 `Origin` 属性，那么再根据实际情况来判断是否使用 `Referer` 值。

## CSRF Token

CSRF Token 的流程大概分为两步：

1. 在浏览器向服务器发送请求时，服务器生成一个 CSRF Token 返回到页面中并隐藏。
2. 如果浏览器要再次向服务器发送其他请求时，那么就需要带上页面中隐藏的 CSRF Token 值。
